<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyShort | L'outil de lien pour les Pros</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 900: '#1e3a8a' }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-800 antialiased selection:bg-brand-500 selection:text-white">

    <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2 cursor-pointer" onclick="showLanding()">
                    <span class="text-2xl">üöÄ</span>
                    <span class="font-bold text-xl tracking-tight text-slate-900">PyShort</span>
                </div>
                <div class="flex items-center gap-4">
                    <div id="proBadge" class="hidden flex items-center gap-1 bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs font-bold border border-yellow-200 shadow-sm">
                        <span>üåü</span> MEMBRE PRO
                    </div>

                    <button id="navLoginBtn" onclick="showLogin()" class="text-sm font-medium text-slate-600 hover:text-brand-600 transition">Connexion</button>
                    <button id="premiumBtn" onclick="showPricing()" class="hidden bg-gradient-to-r from-brand-600 to-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:shadow-lg hover:opacity-90 transition transform hover:-translate-y-0.5">üëë Devenir Premium</button>
                    <button id="dashboardBtn" onclick="showApp()" class="hidden text-sm font-medium text-slate-600 hover:text-brand-600 transition">Dashboard</button>
                    <button id="logoutBtn" onclick="logout()" class="hidden text-sm text-slate-400 hover:text-red-500 transition">D√©connexion</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

        <section id="landingSection" class="fade-in">
            <div class="text-center py-20">
                <h1 class="text-5xl md:text-6xl font-extrabold text-slate-900 tracking-tight mb-6">
                    Domptez vos liens <br>
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-brand-600 to-indigo-600">avec √©l√©gance.</span>
                </h1>
                <p class="text-lg text-slate-600 max-w-2xl mx-auto mb-10">
                    La solution professionnelle pour raccourcir, partager et analyser vos URL. 
                    Rejoignez les experts du marketing qui utilisent PyShort.
                </p>
                <div class="flex justify-center gap-4">
                    <button onclick="showLogin()" class="bg-brand-600 text-white px-8 py-3 rounded-xl font-semibold shadow-lg hover:bg-brand-500 transition hover:shadow-brand-500/30">Commencer gratuitement</button>
                    <button onclick="showPricing()" class="bg-white text-slate-700 border border-slate-300 px-8 py-3 rounded-xl font-semibold hover:bg-slate-50 transition">Voir les offres</button>
                </div>
            </div>

            <div class="grid md:grid-cols-3 gap-8 mt-10">
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition">
                    <div class="text-4xl mb-4">‚ö°</div>
                    <h3 class="font-bold text-xl mb-2">Ultra Rapide</h3>
                    <p class="text-slate-500">Infrastructure cloud haute performance pour des redirections instantan√©es.</p>
                </div>
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition">
                    <div class="text-4xl mb-4">üìä</div>
                    <h3 class="font-bold text-xl mb-2">Analytiques</h3>
                    <p class="text-slate-500">Suivez chaque clic en temps r√©el. Graphiques d√©taill√©s pour les membres PRO.</p>
                </div>
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition">
                    <div class="text-4xl mb-4">üõ°Ô∏è</div>
                    <h3 class="font-bold text-xl mb-2">S√©curis√©</h3>
                    <p class="text-slate-500">Vos donn√©es sont chiffr√©es. HTTPS par d√©faut pour tous vos liens.</p>
                </div>
            </div>
        </section>

        <section id="loginSection" class="hidden fade-in max-w-md mx-auto mt-10">
            <div class="bg-white p-8 rounded-2xl shadow-xl border border-slate-100">
                <h2 class="text-2xl font-bold text-center mb-6 text-slate-800">Bienvenue</h2>
                
                <div class="flex bg-slate-100 p-1 rounded-lg mb-6">
                    <button onclick="toggleAuth('login')" id="tabLogin" class="flex-1 py-2 rounded-md text-sm font-medium bg-white shadow-sm text-slate-800 transition">Connexion</button>
                    <button onclick="toggleAuth('register')" id="tabRegister" class="flex-1 py-2 rounded-md text-sm font-medium text-slate-500 hover:text-slate-700 transition">Inscription</button>
                </div>

                <div id="formLogin" class="space-y-4">
                    <input type="email" id="email" placeholder="Email professionnel" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition">
                    <input type="password" id="password" placeholder="Mot de passe" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition">
                    <button onclick="login()" class="w-full bg-brand-600 text-white py-3 rounded-lg font-semibold hover:bg-brand-500 transition">Se connecter</button>
                </div>

                <div id="formRegister" class="hidden space-y-4">
                    <input type="email" id="reg_email" placeholder="Votre email" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition">
                    <input type="password" id="reg_password" placeholder="Choisir un mot de passe" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition">
                    <button onclick="register()" class="w-full bg-slate-800 text-white py-3 rounded-lg font-semibold hover:bg-slate-700 transition">Cr√©er mon compte</button>
                </div>

                <p id="msgBox" class="text-center text-sm text-red-500 mt-4 h-5"></p>
            </div>
        </section>

        <section id="pricingSection" class="hidden fade-in">
            <h2 class="text-3xl font-bold text-center mb-10">Choisissez votre plan</h2>
            <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                <div class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm text-center">
                    <h3 class="text-xl font-semibold text-slate-600">D√©couverte</h3>
                    <div class="text-4xl font-bold my-4">0 ‚Ç¨</div>
                    <ul class="text-slate-500 space-y-3 mb-8 text-left pl-10">
                        <li>‚úîÔ∏è Liens al√©atoires</li>
                        <li>‚úîÔ∏è QR Codes inclus</li>
                        <li>‚ùå Alias personnalis√©s</li>
                        <li>‚ùå Support prioritaire</li>
                    </ul>
                    <button onclick="showApp()" class="w-full py-3 rounded-xl border border-slate-300 font-semibold text-slate-700 hover:bg-slate-50 transition">Continuer Gratuitement</button>
                </div>
                <div class="bg-white p-8 rounded-2xl border-2 border-brand-500 shadow-xl relative text-center transform md:scale-105">
                    <div class="absolute top-0 right-0 bg-brand-500 text-white text-xs font-bold px-3 py-1 rounded-bl-lg rounded-tr-lg">RECOMMAND√â</div>
                    <h3 class="text-xl font-semibold text-brand-600">üëë BUSINESS</h3>
                    <div class="text-4xl font-bold my-4 text-slate-900">4.99 ‚Ç¨</div>
                    <ul class="text-slate-600 space-y-3 mb-8 text-left pl-10">
                        <li>‚úîÔ∏è Tout du plan gratuit</li>
                        <li>‚úîÔ∏è <strong>Alias Personnalis√©s</strong> (ex: /mon-cv)</li>
                        <li>‚úîÔ∏è <strong>Graphiques & Stats</strong></li>
                        <li>‚úîÔ∏è Support VIP</li>
                    </ul>
                    <button onclick="startPayment()" class="w-full py-3 rounded-xl bg-gradient-to-r from-brand-600 to-indigo-600 text-white font-bold shadow-lg hover:opacity-90 transition">Passer PRO</button>
                </div>
            </div>
            <p class="text-center mt-8 text-slate-400 cursor-pointer hover:text-slate-600" onclick="checkAuthRedirect()">Non merci, je verrai plus tard</p>
        </section>

        <section id="appSection" class="hidden fade-in">
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 mb-10">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><span class="text-brand-500">‚ú®</span> Cr√©er un nouveau lien</h2>
                <div class="flex flex-col md:flex-row gap-4">
                    <input type="url" id="longUrl" placeholder="https://votre-url-tres-longue.com/..." class="flex-grow px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-brand-500 outline-none">
                    <input type="text" id="customKey" placeholder="Alias (Optionnel)" class="md:w-64 px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-brand-500 outline-none">
                    <button onclick="shorten()" class="bg-brand-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-brand-500 shadow-md transition whitespace-nowrap">Raccourcir üöÄ</button>
                </div>
                <div id="result" class="hidden mt-6 p-4 bg-green-50 border border-green-100 rounded-lg flex items-center justify-between">
                    <div class="flex items-center gap-2 text-green-700">
                        <span>‚úÖ Lien cr√©√© :</span>
                        <a href="#" id="shortLink" target="_blank" class="font-bold underline">...</a>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="font-bold text-lg text-slate-700">üìä Vos Liens Actifs</h3>
                    <button onclick="loadMyLinks()" class="text-sm text-brand-600 hover:text-brand-800">Actualiser</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm text-slate-600">
                        <thead class="bg-slate-50 text-slate-800 uppercase text-xs font-bold">
                            <tr>
                                <th class="px-6 py-4">Lien Court</th>
                                <th class="px-6 py-4">Destination</th>
                                <th class="px-6 py-4 text-center">Clics</th>
                                <th class="px-6 py-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="linksTableBody" class="divide-y divide-slate-100">
                            </tbody>
                    </table>
                </div>
            </div>
        </section>

        <div id="chartModal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl p-6 relative">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="chartTitle" class="text-xl font-bold text-slate-800">Statistiques</h3>
                    <button onclick="closeChart()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                </div>
                <div class="relative h-64 md:h-80">
                    <canvas id="myChart"></canvas>
                </div>
            </div>
        </div>

    </main>

    <footer class="border-t border-slate-200 mt-20 py-10 bg-white">
        <div class="max-w-7xl mx-auto px-4 text-center text-slate-400 text-sm">
            <p>&copy; 2026 PyShort SaaS. Designed with passion.</p>
        </div>
    </footer>

    <script>
        // --- UI UTILS ---
        function toggleAuth(type) {
            if(type === 'login') {
                document.getElementById('formLogin').classList.remove('hidden');
                document.getElementById('formRegister').classList.add('hidden');
                document.getElementById('tabLogin').classList.add('bg-white', 'shadow-sm', 'text-slate-800');
                document.getElementById('tabLogin').classList.remove('text-slate-500');
                document.getElementById('tabRegister').classList.remove('bg-white', 'shadow-sm', 'text-slate-800');
                document.getElementById('tabRegister').classList.add('text-slate-500');
            } else {
                document.getElementById('formLogin').classList.add('hidden');
                document.getElementById('formRegister').classList.remove('hidden');
                document.getElementById('tabRegister').classList.add('bg-white', 'shadow-sm', 'text-slate-800');
                document.getElementById('tabRegister').classList.remove('text-slate-500');
                document.getElementById('tabLogin').classList.remove('bg-white', 'shadow-sm', 'text-slate-800');
                document.getElementById('tabLogin').classList.add('text-slate-500');
            }
        }

        function hideAll() {
            ['landingSection', 'loginSection', 'pricingSection', 'appSection'].forEach(id => 
                document.getElementById(id).classList.add('hidden')
            );
        }

        function showLanding() {
            hideAll();
            document.getElementById('landingSection').classList.remove('hidden');
            updateNav(false);
        }

        function showLogin() {
            hideAll();
            document.getElementById('loginSection').classList.remove('hidden');
        }

        function showPricing() {
            hideAll();
            document.getElementById('pricingSection').classList.remove('hidden');
        }

        function showApp() {
            hideAll();
            document.getElementById('appSection').classList.remove('hidden');
            updateNav(true);
            loadMyLinks();
        }

        function updateNav(isLoggedIn) {
            if (isLoggedIn) {
                document.getElementById('navLoginBtn').classList.add('hidden');
                document.getElementById('dashboardBtn').classList.remove('hidden');
                document.getElementById('logoutBtn').classList.remove('hidden');
            } else {
                document.getElementById('navLoginBtn').classList.remove('hidden');
                document.getElementById('dashboardBtn').classList.add('hidden');
                document.getElementById('logoutBtn').classList.add('hidden');
                document.getElementById('premiumBtn').classList.add('hidden');
                document.getElementById('proBadge').classList.add('hidden');
            }
        }

        function checkAuthRedirect() {
            if(localStorage.getItem('token')) showApp();
            else showLanding();
        }

        // --- BACKEND LOGIC ---
        async function register() {
            const email = document.getElementById('reg_email').value;
            const password = document.getElementById('reg_password').value;
            try {
                const res = await fetch('/register', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, password})});
                if(res.ok) { alert("Compte cr√©√© ! Connectez-vous."); toggleAuth('login'); }
                else alert("Erreur inscription");
            } catch(e) { console.error(e); }
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const formData = new FormData(); formData.append('username', email); formData.append('password', password);
            const res = await fetch('/token', { method: 'POST', body: formData });
            if(res.ok) {
                const data = await res.json();
                localStorage.setItem('token', data.access_token);
                showApp();
            } else {
                document.getElementById('msgBox').innerText = "Identifiants incorrects";
            }
        }

        function logout() { localStorage.removeItem('token'); showLanding(); }

        async function shorten() {
            const token = localStorage.getItem('token');
            const res = await fetch('/shorten', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ url: document.getElementById('longUrl').value, custom_key: document.getElementById('customKey').value })
            });
            const data = await res.json();
            if(res.ok) { 
                loadMyLinks(); 
                const fullLink = window.location.origin + "/" + data.short_key;
                const resultDiv = document.getElementById('result');
                document.getElementById('shortLink').href = fullLink;
                document.getElementById('shortLink').innerText = fullLink;
                resultDiv.classList.remove('hidden');
                
                // Petit effet de succ√®s
                confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 }, colors: ['#3b82f6', '#1e3a8a'] });
            }
            else if(res.status === 403) { if(confirm("üîí R√©serv√© aux membres PRO.\nVoir les offres ?")) showPricing(); }
            else { alert(data.detail); }
        }

        async function loadMyLinks() {
            const token = localStorage.getItem('token');
            const res = await fetch('/users/me', { headers: { 'Authorization': 'Bearer ' + token } });
            
            if (res.ok) {
                const user = await res.json();
                
                // UI PREMIUM
                if (user.is_premium) {
                    document.getElementById('premiumBtn').classList.add('hidden');
                    document.getElementById('proBadge').classList.remove('hidden');
                    document.getElementById('customKey').placeholder = "Alias personnalis√© (ex: mon-cv)";
                } else {
                    document.getElementById('premiumBtn').classList.remove('hidden');
                    document.getElementById('proBadge').classList.add('hidden');
                    document.getElementById('customKey').placeholder = "Alias (ex: google) - PRO seulement";
                }

                const tbody = document.getElementById('linksTableBody');
                tbody.innerHTML = ''; 
                user.items.forEach(item => {
                    const shortUrl = window.location.origin + "/" + item.short_key;
                    const historyData = JSON.stringify(item.click_history);
                    
                    tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 transition">
                        <td class="px-6 py-4 font-medium text-brand-600"><a href="${shortUrl}" target="_blank">/${item.short_key}</a></td>
                        <td class="px-6 py-4 text-slate-500 truncate max-w-xs">${item.url}</td>
                        <td class="px-6 py-4 text-center font-bold bg-slate-100 rounded-lg">${item.clicks}</td>
                        <td class="px-6 py-4 text-right space-x-2">
                            <button onclick='openChart("${item.short_key}", ${historyData})' class="text-indigo-500 hover:text-indigo-700 font-medium text-sm border border-indigo-200 px-3 py-1 rounded-md hover:bg-indigo-50 transition">Stats üìä</button>
                            <button onclick='deleteLink("${item.short_key}")' class="text-red-500 hover:text-red-700 text-sm px-2 py-1">&times;</button>
                        </td>
                    </tr>`;
                });
            } else { logout(); }
        }

        // --- CHART ---
        let myChartInstance = null;
        function openChart(shortKey, history) {
            document.getElementById('chartModal').classList.remove('hidden');
            document.getElementById('chartTitle').innerText = "Statistiques : /" + shortKey;
            
            const clicksByDate = {};
            history.forEach(h => {
                const date = new Date(h.timestamp).toLocaleDateString();
                clicksByDate[date] = (clicksByDate[date] || 0) + 1;
            });

            const ctx = document.getElementById('myChart').getContext('2d');
            if(myChartInstance) myChartInstance.destroy();

            myChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(clicksByDate),
                    datasets: [{
                        label: 'Clics par jour',
                        data: Object.values(clicksByDate),
                        backgroundColor: '#3b82f6',
                        borderRadius: 5
                    }]
                },
                options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                    plugins: { legend: { display: false } }
                }
            });
        }
        function closeChart() { document.getElementById('chartModal').classList.add('hidden'); }

        // --- ACTIONS ---
        async function deleteLink(k) { if(confirm("Supprimer ce lien ?")) { await fetch('/links/'+k, { method: 'DELETE', headers: {'Authorization': 'Bearer '+localStorage.getItem('token')} }); loadMyLinks(); } }
        async function startPayment() { 
            const u = (await (await fetch('/create-checkout-session', {method:'POST', headers:{'Authorization':'Bearer '+localStorage.getItem('token')}})).json()).checkout_url; 
            window.location.href = u; 
        }

        // INIT
        checkAuthRedirect();
    </script>
</body>
</html>