<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyShort - Freemium</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        .hidden { display: none; }
        .dashboard-table { margin-top: 30px; }
        .click-count { font-weight: bold; color: #1095c1; }
        .delete-btn { background-color: #d93526; border-color: #d93526; padding: 5px 10px; font-size: 0.8em; }
        .auth-buttons { display: flex; gap: 10px; }
        
        /* Nouveau Style pour les Prix */
        .pricing-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .plan-card { padding: 20px; border: 1px solid #ccc; border-radius: 8px; text-align: center; }
        .plan-pro { border: 2px solid #1095c1; box-shadow: 0 0 15px rgba(16, 149, 193, 0.2); }
        .price { font-size: 2em; font-weight: bold; margin: 10px 0; }
    </style>
</head>
<body>
    <main class="container">
        <nav>
            <ul>
                <li><strong>ðŸš€ PyShort</strong></li>
            </ul>
            <ul>
                <li><a href="#" onclick="showPricing()" id="premiumBtn" class="hidden">ðŸ‘‘ Devenir Premium</a></li>
                <li><a href="#" onclick="logout()" id="logoutBtn" class="hidden">Se dÃ©connecter</a></li>
            </ul>
        </nav>

        <section id="loginSection">
            <article>
                <header>Bienvenue sur PyShort</header>
                <p>La solution professionnelle pour vos liens courts.</p>
                <input type="email" id="email" placeholder="Email">
                <input type="password" id="password" placeholder="Mot de passe">
                <div class="auth-buttons">
                    <button onclick="login()">Se connecter</button>
                    <button onclick="register()" class="secondary outline">CrÃ©er un compte</button>
                </div>
                <p id="msgBox" style="margin-top: 10px;"></p>
            </article>
        </section>

        <section id="pricingSection" class="hidden">
            <h2 style="text-align: center;">Choisissez votre offre</h2>
            <div class="pricing-grid">
                <article class="plan-card">
                    <header>DÃ©butant</header>
                    <div class="price">0 â‚¬</div>
                    <ul>
                        <li>Liens alÃ©atoires</li>
                        <li>QR Codes inclus</li>
                        <li>Pubs affichÃ©es</li>
                    </ul>
                    <button class="secondary outline" onclick="showApp()">Continuer Gratuitement</button>
                </article>

                <article class="plan-card plan-pro">
                    <header>ðŸ‘‘ PRO</header>
                    <div class="price">4.99 â‚¬</div>
                    <ul>
                        <li><strong>Alias PersonnalisÃ©s</strong></li>
                        <li>Statistiques dÃ©taillÃ©es</li>
                        <li>Support Prioritaire</li>
                    </ul>
                    <button onclick="startPayment()">Passer PRO</button>
                </article>
            </div>
            <p style="text-align: center; margin-top: 20px;">
                <a href="#" onclick="showApp()">Retour au Dashboard</a>
            </p>
        </section>

        <section id="appSection" class="hidden">
            <article>
                <header>âœ¨ CrÃ©er un nouveau lien</header>
                <div class="grid">
                    <input type="url" id="longUrl" placeholder="https://..." required>
                    <input type="text" id="customKey" placeholder="Alias (ex: google) - PRO seulement">
                    <button onclick="shorten()">Raccourcir</button>
                </div>
                <div id="result" class="hidden">
                    <p>Lien prÃªt : <a href="#" id="shortLink" target="_blank">...</a></p>
                </div>
            </article>

            <div class="dashboard-table">
                <h3>ðŸ“Š Mes Liens</h3>
                <figure>
                    <table role="grid">
                        <thead>
                            <tr>
                                <th>Lien Court</th>
                                <th>Original</th>
                                <th>QR</th>
                                <th>Clics</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="linksTableBody"></tbody>
                    </table>
                </figure>
                <button class="secondary outline" onclick="loadMyLinks()">ðŸ”„ Actualiser</button>
            </div>
        </section>
    </main>

    <script>
        // --- LOGIQUE ---
        async function register() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                const res = await fetch('/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                if (res.ok) document.getElementById('msgBox').innerText = "Compte crÃ©Ã© ! Connectez-vous.";
                else document.getElementById('msgBox').innerText = "Erreur inscription.";
            } catch (e) { console.error(e); }
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const formData = new FormData();
            formData.append('username', email);
            formData.append('password', password);

            try {
                const res = await fetch('/token', { method: 'POST', body: formData });
                const data = await res.json();
                if (res.ok) {
                    localStorage.setItem('token', data.access_token);
                    showApp();
                } else {
                    document.getElementById('msgBox').innerText = "Erreur de connexion";
                }
            } catch (e) { console.error(e); }
        }

        async function shorten() {
            const longUrl = document.getElementById('longUrl').value;
            const customKey = document.getElementById('customKey').value;
            const token = localStorage.getItem('token');
            const payload = { url: longUrl };
            if (customKey) payload.custom_key = customKey;

            const res = await fetch('/shorten', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            if (res.ok) {
                const fullLink = window.location.origin + "/" + data.short_key;
                document.getElementById('shortLink').href = fullLink;
                document.getElementById('shortLink').innerText = fullLink;
                document.getElementById('result').classList.remove('hidden');
                loadMyLinks(); 
            } else {
                // Si l'erreur concerne le Premium, on propose l'upgrade
                if(res.status === 403) {
                    if(confirm("Cette fonction est rÃ©servÃ©e aux membres PRO. Voir les offres ?")) {
                        showPricing();
                    }
                } else {
                    alert("Erreur : " + data.detail);
                }
            }
        }

        async function loadMyLinks() {
            const token = localStorage.getItem('token');
            const res = await fetch('/users/me', { headers: { 'Authorization': 'Bearer ' + token } });
            if (res.ok) {
                const user = await res.json();
                const tbody = document.getElementById('linksTableBody');
                tbody.innerHTML = ''; 
                user.items.forEach(item => {
                    const shortUrl = window.location.origin + "/" + item.short_key;
                    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=${shortUrl}`;
                    tbody.innerHTML += `<tr>
                        <td><a href="${shortUrl}" target="_blank">/${item.short_key}</a></td>
                        <td><small>${item.url.substring(0, 20)}...</small></td>
                        <td><a href="${qrUrl}" download><img src="${qrUrl}" width="40"></a></td>
                        <td>${item.clicks}</td>
                        <td><button class="delete-btn" onclick="deleteLink('${item.short_key}')">X</button></td>
                    </tr>`;
                });
            }
        }

        async function deleteLink(shortKey) {
            if(!confirm("Supprimer ?")) return;
            const token = localStorage.getItem('token');
            await fetch('/links/' + shortKey, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } });
            loadMyLinks();
        }

        // --- NAVIGATION ---
        function showApp() {
            hideAll();
            document.getElementById('appSection').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            document.getElementById('premiumBtn').classList.remove('hidden');
            loadMyLinks();
        }

        function showPricing() {
            hideAll();
            document.getElementById('pricingSection').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
        }

        function hideAll() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('appSection').classList.add('hidden');
            document.getElementById('pricingSection').classList.add('hidden');
        }

        function logout() {
            localStorage.removeItem('token');
            location.reload();
        }

        async function startPayment() {
    const token = localStorage.getItem('token');
    
    // 1. On demande au backend de crÃ©er la session
    const response = await fetch('/create-checkout-session', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token }
    });

    const data = await response.json();

    // 2. Si Ã§a marche, on redirige l'utilisateur vers Stripe
    if (data.checkout_url) {
        window.location.href = data.checkout_url;
    } else {
        alert("Erreur lors de la crÃ©ation du paiement");
    }
}

        if (localStorage.getItem('token')) showApp();
    </script>
</body>
</html>