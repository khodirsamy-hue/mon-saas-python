<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyShort - Analytics</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .hidden { display: none !important; }
        .dashboard-table { margin-top: 30px; }
        .delete-btn { background-color: #d93526; border-color: #d93526; padding: 5px 10px; font-size: 0.8em; }
        .stats-btn { background-color: #1095c1; border-color: #1095c1; padding: 5px 10px; font-size: 0.8em; margin-right: 5px; }
        .auth-buttons { display: flex; gap: 10px; }
        .pro-badge { color: #FFD700; font-weight: bold; border: 1px solid #FFD700; padding: 5px 10px; border-radius: 20px; }
        
        /* Style de la fenÃªtre modale (Pop-up) */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #1f2937; padding: 20px; border-radius: 10px; width: 90%; max-width: 600px; color: white; }
    </style>
</head>
<body>
    <main class="container">
        <nav>
            <ul>
                <li><strong>ðŸš€ PyShort</strong></li>
            </ul>
            <ul>
                <li id="proBadge" class="hidden"><span class="pro-badge">ðŸŒŸ MEMBRE PRO</span></li>
                <li><a href="#" onclick="showPricing()" id="premiumBtn" class="hidden">ðŸ‘‘ Devenir Premium</a></li>
                <li><a href="#" onclick="logout()" id="logoutBtn" class="hidden">Se dÃ©connecter</a></li>
            </ul>
        </nav>

        <section id="loginSection">
            <article>
                <header>Connexion</header>
                <input type="email" id="email" placeholder="Email">
                <input type="password" id="password" placeholder="Mot de passe">
                <div class="auth-buttons">
                    <button onclick="login()">Se connecter</button>
                    <button onclick="register()" class="secondary outline">CrÃ©er un compte</button>
                </div>
                <p id="msgBox"></p>
            </article>
        </section>

        <section id="pricingSection" class="hidden">
            <h2 style="text-align: center;">Offres</h2>
            <div class="grid">
                <article>
                    <header>Gratuit</header>
                    <h3>0 â‚¬</h3>
                    <ul><li>Liens alÃ©atoires</li><li>Pubs</li></ul>
                    <button class="secondary outline" onclick="showApp()">Continuer</button>
                </article>
                <article style="border: 2px solid #1095c1;">
                    <header>ðŸ‘‘ PRO</header>
                    <h3>4.99 â‚¬</h3>
                    <ul><li>Alias PersonnalisÃ©s</li><li><strong>Graphiques de Clics</strong></li></ul>
                    <button onclick="startPayment()">Passer PRO</button>
                </article>
            </div>
        </section>

        <section id="appSection" class="hidden">
            <article>
                <header>âœ¨ Nouveau lien</header>
                <div class="grid">
                    <input type="url" id="longUrl" placeholder="https://..." required>
                    <input type="text" id="customKey" placeholder="Alias optionnel">
                    <button onclick="shorten()">Raccourcir</button>
                </div>
                <p id="result" class="hidden">Lien prÃªt : <a href="#" id="shortLink" target="_blank">...</a></p>
            </article>

            <div class="dashboard-table">
                <h3>ðŸ“Š Mes Liens</h3>
                <figure>
                    <table role="grid">
                        <thead>
                            <tr>
                                <th>Lien Court</th>
                                <th>Origine</th>
                                <th>Clics</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="linksTableBody"></tbody>
                    </table>
                </figure>
                <button class="secondary outline" onclick="loadMyLinks()">ðŸ”„ Actualiser</button>
            </div>
        </section>

        <div id="chartModal" class="hidden modal">
            <div class="modal-content">
                <h3 id="chartTitle">Statistiques</h3>
                <canvas id="myChart"></canvas>
                <br>
                <button class="secondary" onclick="closeChart()">Fermer</button>
            </div>
        </div>

    </main>

    <script>
        let myChartInstance = null; // Pour stocker le graphique

        // --- AUTH & NAVIGATION ---
        async function register() { /* ... Idem avant ... */ 
            const email = document.getElementById('email').value; const password = document.getElementById('password').value;
            await fetch('/register', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({email, password})});
            alert("Compte crÃ©Ã© !");
        }
        async function login() { 
            const email = document.getElementById('email').value; const password = document.getElementById('password').value;
            const formData = new FormData(); formData.append('username', email); formData.append('password', password);
            const res = await fetch('/token', { method: 'POST', body: formData });
            if(res.ok) { const data = await res.json(); localStorage.setItem('token', data.access_token); showApp(); }
        }
        function logout() { localStorage.removeItem('token'); location.reload(); }
        
        function showApp() { 
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('pricingSection').classList.add('hidden');
            document.getElementById('appSection').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            loadMyLinks(); 
        }
        function showPricing() {
            document.getElementById('appSection').classList.add('hidden');
            document.getElementById('pricingSection').classList.remove('hidden');
        }

        // --- LIENS & STATS ---
        async function shorten() {
            const token = localStorage.getItem('token');
            const res = await fetch('/shorten', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ url: document.getElementById('longUrl').value, custom_key: document.getElementById('customKey').value })
            });
            if(res.ok) { loadMyLinks(); document.getElementById('result').classList.remove('hidden'); }
            else if(res.status === 403) { if(confirm("Passer PRO ?")) showPricing(); }
        }

        async function loadMyLinks() {
            const token = localStorage.getItem('token');
            const res = await fetch('/users/me', { headers: { 'Authorization': 'Bearer ' + token } });
            
            if (res.ok) {
                const user = await res.json();
                
                // Gestion de l'affichage Premium/Gratuit
                if (user.is_premium) {
                    document.getElementById('premiumBtn').classList.add('hidden');
                    document.getElementById('proBadge').classList.remove('hidden');
                } else {
                    document.getElementById('premiumBtn').classList.remove('hidden');
                    document.getElementById('proBadge').classList.add('hidden');
                }

                const tbody = document.getElementById('linksTableBody');
                tbody.innerHTML = ''; 
                
                user.items.forEach(item => {
                    // On recrÃ©e le lien complet pour qu'il soit cliquable
                    const shortUrl = window.location.origin + "/" + item.short_key;
                    
                    // On prÃ©pare les donnÃ©es du graphique
                    const historyData = JSON.stringify(item.click_history);
                    
                    tbody.innerHTML += `<tr>
                        <td><a href="${shortUrl}" target="_blank">/${item.short_key}</a></td>
                        
                        <td>${item.url.substring(0, 20)}...</td>
                        <td><strong>${item.clicks}</strong></td>
                        <td>
                            <button class='stats-btn' onclick='openChart("${item.short_key}", ${historyData})'>ðŸ“ˆ</button>
                            <button class='delete-btn' onclick='deleteLink("${item.short_key}")'>X</button>
                        </td>
                    </tr>`;
                });
            }
        }

        // --- FONCTION GRAPHIQUE ---
        function openChart(shortKey, history) {
            document.getElementById('chartModal').classList.remove('hidden');
            document.getElementById('chartTitle').innerText = "Stats pour /" + shortKey;

            // 1. PrÃ©parer les donnÃ©es (compter les clics par jour)
            const clicksByDate = {};
            history.forEach(h => {
                const date = new Date(h.timestamp).toLocaleDateString(); // "01/01/2026"
                clicksByDate[date] = (clicksByDate[date] || 0) + 1;
            });

            const labels = Object.keys(clicksByDate);
            const data = Object.values(clicksByDate);

            // 2. Dessiner le graphique
            const ctx = document.getElementById('myChart').getContext('2d');
            
            // Si un graphique existe dÃ©jÃ , on le dÃ©truit pour pas qu'ils se superposent
            if(myChartInstance) myChartInstance.destroy();

            myChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nombre de clics',
                        data: data,
                        borderColor: '#1095c1',
                        backgroundColor: 'rgba(16, 149, 193, 0.2)',
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });
        }

        function closeChart() {
            document.getElementById('chartModal').classList.add('hidden');
        }

        async function deleteLink(k) { await fetch('/links/'+k, { method: 'DELETE', headers: {'Authorization': 'Bearer '+localStorage.getItem('token')} }); loadMyLinks(); }
        async function startPayment() { /* Code Stripe... */ window.location.href = (await (await fetch('/create-checkout-session', {method:'POST', headers:{'Authorization':'Bearer '+localStorage.getItem('token')}})).json()).checkout_url; }

        if (localStorage.getItem('token')) showApp();
    </script>
</body>
</html>