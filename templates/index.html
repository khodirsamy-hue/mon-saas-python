<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyShort - Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        .hidden { display: none; }
        .dashboard-table { margin-top: 30px; }
        .click-count { font-weight: bold; color: #1095c1; }
        .delete-btn { background-color: #d93526; border-color: #d93526; padding: 5px 10px; font-size: 0.8em; }
        /* Style pour les boutons c√¥te √† c√¥te */
        .auth-buttons { display: flex; gap: 10px; }
    </style>
</head>
<body>
    <main class="container">
        <nav>
            <ul>
                <li><strong>üöÄ PyShort</strong></li>
            </ul>
            <ul>
                <li><a href="#" onclick="logout()" id="logoutBtn" class="hidden">Se d√©connecter</a></li>
            </ul>
        </nav>

        <section id="loginSection">
            <article>
                <header>Bienvenue</header>
                <p>Connectez-vous ou cr√©ez un compte pour g√©rer vos liens.</p>
                
                <input type="email" id="email" placeholder="Email (ex: moi@test.com)">
                <input type="password" id="password" placeholder="Mot de passe">
                
                <div class="auth-buttons">
                    <button onclick="login()">Se connecter</button>
                    <button onclick="register()" class="secondary outline">Cr√©er un compte</button>
                </div>
                
                <p id="loginError" style="color: red; margin-top: 10px;"></p>
                <p id="registerSuccess" style="color: green; margin-top: 10px;"></p>
            </article>
        </section>

        <section id="appSection" class="hidden">
            <article>
                <header>‚ú® Cr√©er un nouveau lien</header>
                <div class="grid">
                    <input type="url" id="longUrl" placeholder="Votre lien long (https://...)" required>
                    <input type="text" id="customKey" placeholder="Alias optionnel (ex: mon-cv)">
                    <button onclick="shorten()">Raccourcir</button>
                </div>
                <div id="result" class="hidden">
                    <p>Lien pr√™t : <a href="#" id="shortLink" target="_blank">...</a></p>
                </div>
            </article>

            <div class="dashboard-table">
                <h3>üìä Mes Liens & Stats</h3>
                <figure>
                    <table role="grid">
                        <thead>
                            <tr>
                                <th scope="col">Lien Court</th>
                                <th scope="col">Lien Original</th>
                                <th scope="col">QR</th> <th scope="col">Clics</th>
                                <th scope="col">Action</th>
                            </tr>
                        </thead>
                        <tbody id="linksTableBody">
                            </tbody>
                    </table>
                </figure>
                <button class="secondary outline" onclick="loadMyLinks()">üîÑ Actualiser les stats</button>
            </div>
        </section>
    </main>

    <script>
        // --- 1. INSCRIPTION (Nouveau) ---
        async function register() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if(!email || !password) {
                alert("Merci de remplir l'email et le mot de passe.");
                return;
            }

            try {
                // On envoie en JSON pour l'inscription
                const response = await fetch('/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email, password: password })
                });

                if (response.ok) {
                    document.getElementById('registerSuccess').innerText = "Compte cr√©√© avec succ√®s ! Vous pouvez cliquer sur 'Se connecter'.";
                    document.getElementById('loginError').innerText = "";
                } else {
                    const data = await response.json();
                    document.getElementById('loginError').innerText = "Erreur Inscription : " + (data.detail || "Email d√©j√† pris");
                }
            } catch (error) { console.error(error); }
        }

        // --- 2. CONNEXION ---
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            // On envoie en FormData pour le login (OAuth2 standard)
            const formData = new FormData();
            formData.append('username', email);
            formData.append('password', password);

            try {
                const response = await fetch('/token', { method: 'POST', body: formData });
                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem('token', data.access_token);
                    document.getElementById('registerSuccess').innerText = "";
                    document.getElementById('loginError').innerText = "";
                    showApp();
                } else {
                    document.getElementById('loginError').innerText = "Email ou mot de passe incorrect.";
                }
            } catch (error) { console.error(error); }
        }

        // --- 3. RACCOURCIR ---
        async function shorten() {
            const longUrl = document.getElementById('longUrl').value;
            const customKey = document.getElementById('customKey').value;
            const token = localStorage.getItem('token');

            const payload = { url: longUrl };
            if (customKey) payload.custom_key = customKey;

            const response = await fetch('/shorten', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            
            if (response.ok) {
                const fullLink = window.location.origin + "/" + data.short_key;
                document.getElementById('shortLink').href = fullLink;
                document.getElementById('shortLink').innerText = fullLink;
                document.getElementById('result').classList.remove('hidden');
                loadMyLinks(); 
            } else {
                alert("Erreur : " + data.detail);
            }
        }

        // --- 4. CHARGER MES LIENS (Avec QR Codes) ---
        async function loadMyLinks() {
            const token = localStorage.getItem('token');
            const response = await fetch('/users/me', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            
            if (response.ok) {
                const user = await response.json();
                const tbody = document.getElementById('linksTableBody');
                tbody.innerHTML = ''; 

                user.items.forEach(item => {
                    const shortUrl = window.location.origin + "/" + item.short_key;
                    // L'API QR Code :
                    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=${shortUrl}`;

                    const row = `
                        <tr>
                            <td><a href="${shortUrl}" target="_blank">/${item.short_key}</a></td>
                            <td><small>${item.url.substring(0, 20)}...</small></td>
                            <td>
                                <a href="${qrUrl}" download="qrcode.png" target="_blank">
                                    <img src="${qrUrl}" alt="QR" width="40">
                                </a>
                            </td>
                            <td class="click-count">${item.clicks} üñ±Ô∏è</td>
                            <td>
                                <button class="delete-btn" onclick="deleteLink('${item.short_key}')">X</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }
        }

        // --- 5. SUPPRIMER ---
        async function deleteLink(shortKey) {
            if(!confirm("Supprimer ce lien ?")) return;
            const token = localStorage.getItem('token');
            const response = await fetch('/links/' + shortKey, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (response.ok) loadMyLinks();
        }

        // GESTION AFFICHAGE
        function showApp() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('appSection').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            loadMyLinks();
        }

        function logout() {
            localStorage.removeItem('token');
            location.reload();
        }

        if (localStorage.getItem('token')) showApp();
    </script>
</body>
</html>