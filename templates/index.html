<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyShort - Raccourcissez, Partagez, Analysez.</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* UTILS */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        
        /* HERO SECTION */
        .hero { padding: 60px 0; text-align: center; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 20px; margin-bottom: 40px; }
        .hero h1 { font-size: 3em; color: #1095c1; margin-bottom: 10px; }
        .hero p { font-size: 1.2em; color: #555; max-width: 600px; margin: 0 auto 30px auto; }
        
        /* FEATURES */
        .feature-card { padding: 20px; border: 1px solid #eee; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; }
        .icon { font-size: 2em; margin-bottom: 10px; display: block; }

        /* DASHBOARD */
        .dashboard-table { margin-top: 30px; }
        .delete-btn { background-color: #d93526; border-color: #d93526; padding: 5px 10px; font-size: 0.8em; }
        .stats-btn { background-color: #1095c1; border-color: #1095c1; padding: 5px 10px; font-size: 0.8em; margin-right: 5px; }
        .pro-badge { color: #FFD700; font-weight: bold; border: 1px solid #FFD700; padding: 5px 10px; border-radius: 20px; }
        
        /* MODAL */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #1f2937; padding: 20px; border-radius: 10px; width: 90%; max-width: 600px; color: white; }
    </style>
</head>
<body>
    <main class="container">
        <nav>
            <ul>
                <li><strong>üöÄ PyShort</strong></li>
            </ul>
            <ul>
                <li id="proBadge" class="hidden"><span class="pro-badge">üåü MEMBRE PRO</span></li>
                <li><a href="#" onclick="showLogin()" id="navLoginBtn">Connexion</a></li>
                <li><a href="#" onclick="showPricing()" id="premiumBtn" class="hidden">üëë Devenir Premium</a></li>
                <li><a href="#" onclick="showApp()" id="dashboardBtn" class="hidden">Dashboard</a></li>
                <li><a href="#" onclick="logout()" id="logoutBtn" class="hidden">D√©connexion</a></li>
            </ul>
        </nav>

        <section id="landingSection">
            <div class="hero">
                <h1>Domptez vos liens.</h1>
                <p>La solution ultime pour raccourcir vos URL, suivre vos clics en temps r√©el et booster votre marketing.</p>
                <div class="grid">
                    <button onclick="showLogin()">Commencer gratuitement</button>
                    <button class="secondary outline" onclick="showPricing()">Voir les offres</button>
                </div>
            </div>

            <div class="grid-3">
                <div class="feature-card">
                    <span class="icon">‚ö°</span>
                    <h3>Ultra Rapide</h3>
                    <p>Redirections instantan√©es et infrastructure haute performance.</p>
                </div>
                <div class="feature-card">
                    <span class="icon">üìä</span>
                    <h3>Analytiques</h3>
                    <p>Suivez chaque clic. Graphiques d√©taill√©s pour nos membres PRO.</p>
                </div>
                <div class="feature-card">
                    <span class="icon">üîí</span>
                    <h3>S√©curis√©</h3>
                    <p>Vos donn√©es sont prot√©g√©es et vos liens sont HTTPS par d√©faut.</p>
                </div>
            </div>
        </section>

        <section id="loginSection" class="hidden">
            <article>
                <header class="text-center">Bienvenue sur PyShort</header>
                <div class="grid">
                    <div>
                        <h3>Se connecter</h3>
                        <input type="email" id="email" placeholder="Email">
                        <input type="password" id="password" placeholder="Mot de passe">
                        <button onclick="login()">Connexion</button>
                        
                    
                    </div>
                    <div style="border-left: 1px solid #ccc; padding-left: 20px;">
                        <h3>Nouveau ?</h3>
                        <p>Cr√©ez un compte en 10 secondes pour g√©rer vos liens.</p>
                        <input type="email" id="reg_email" placeholder="Email">
                        <input type="password" id="reg_password" placeholder="Mot de passe">
                        <button onclick="register()" class="secondary">Cr√©er mon compte</button>
                    </div>
                </div>
                <p id="msgBox" class="text-center"></p>
                <p class="text-center"><a href="#" onclick="showLanding()">Retour √† l'accueil</a></p>
            </article>
        </section>

        <section id="pricingSection" class="hidden">
            <h2 class="text-center">Nos Tarifs</h2>
            <div class="grid">
                <article class="text-center">
                    <header>D√©couverte</header>
                    <h3>0 ‚Ç¨ <small>/ mois</small></h3>
                    <ul><li>Liens al√©atoires</li><li>Gestion basique</li><li>Pubs</li></ul>
                    <button class="secondary outline" onclick="showApp()">Choisir</button>
                </article>
                <article class="text-center" style="border: 2px solid #1095c1; transform: scale(1.05);">
                    <header>üëë BUSINESS</header>
                    <h3>4.99 ‚Ç¨ <small>/ mois</small></h3>
                    <ul><li>Alias Personnalis√©s</li><li><strong>Graphiques de Clics</strong></li><li>Support VIP</li></ul>
                    <button onclick="startPayment()">Passer PRO</button>
                </article>
            </div>
            <p class="text-center"><a href="#" onclick="checkAuthRedirect()">Retour</a></p>
        </section>

        <section id="appSection" class="hidden">
            <article>
                <header>‚ú® Raccourcir un lien</header>
                <div class="grid">
                    <input type="url" id="longUrl" placeholder="https://votre-site-tres-long.com/..." required>
                    <input type="text" id="customKey" placeholder="Alias (ex: promo-ete)">
                    <button onclick="shorten()">G√©n√©rer</button>
                </div>
                <p id="result" class="hidden text-center">üëâ <a href="#" id="shortLink" target="_blank">...</a></p>
            </article>

            <div class="dashboard-table">
                <h3>üìä Vos Performances</h3>
                <figure>
                    <table role="grid">
                        <thead><tr><th>Lien Court</th><th>Cible</th><th>Clics</th><th>Actions</th></tr></thead>
                        <tbody id="linksTableBody"></tbody>
                    </table>
                </figure>
                <button class="secondary outline" onclick="loadMyLinks()">üîÑ Actualiser</button>
            </div>
        </section>

        <div id="chartModal" class="hidden modal">
            <div class="modal-content">
                <h3 id="chartTitle">Statistiques</h3>
                <canvas id="myChart"></canvas>
                <br><button class="secondary" onclick="closeChart()">Fermer</button>
            </div>
        </div>

        <footer class="text-center" style="margin-top: 50px; color: #888; font-size: 0.8em;">
            <p>¬© 2026 PyShort Inc. Fait avec ‚ù§Ô∏è et Python.</p>
        </footer>
    </main>

    <script>
        // --- GESTION DE L'AFFICHAGE ---
        function hideAll() {
            ['landingSection', 'loginSection', 'pricingSection', 'appSection'].forEach(id => 
                document.getElementById(id).classList.add('hidden')
            );
        }

        function showLanding() {
            hideAll();
            document.getElementById('landingSection').classList.remove('hidden');
            document.getElementById('navLoginBtn').classList.remove('hidden');
            document.getElementById('dashboardBtn').classList.add('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
        }

        function showLogin() {
            hideAll();
            document.getElementById('loginSection').classList.remove('hidden');
        }

        function showPricing() {
            hideAll();
            document.getElementById('pricingSection').classList.remove('hidden');
        }

        function showApp() {
            hideAll();
            document.getElementById('appSection').classList.remove('hidden');
            document.getElementById('navLoginBtn').classList.add('hidden');
            document.getElementById('dashboardBtn').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            loadMyLinks();
        }

        function checkAuthRedirect() {
            if(localStorage.getItem('token')) showApp();
            else showLanding();
        }

        // --- AUTH ---
        async function register() {
            const email = document.getElementById('reg_email').value;
            const password = document.getElementById('reg_password').value;
            try {
                const res = await fetch('/register', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, password})});
                if(res.ok) alert("Compte cr√©√© ! Connectez-vous √† gauche.");
                else alert("Erreur inscription");
            } catch(e) { console.error(e); }
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const formData = new FormData(); formData.append('username', email); formData.append('password', password);
            const res = await fetch('/token', { method: 'POST', body: formData });
            if(res.ok) {
                const data = await res.json();
                localStorage.setItem('token', data.access_token);
                showApp();
            } else {
                document.getElementById('msgBox').innerText = "Identifiants incorrects";
            }
        }

        function logout() { localStorage.removeItem('token'); showLanding(); }

        // --- ICI : LA NOUVELLE FONCTION POUR LE MOT DE PASSE ---
        async function forgotPassword() {
            const email = prompt("Entrez votre email pour recevoir le lien de r√©initialisation :");
            if(email) {
                try {
                    const res = await fetch('/forgot-password', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ email })
                    });
                    // On affiche le message quoi qu'il arrive (s√©curit√©)
                    alert("Si cet email existe, un lien a √©t√© envoy√© ! V√©rifiez vos spams.");
                } catch(e) { console.error(e); }
            }
        }

        // --- CORE FEATURES ---
        async function shorten() {
            const token = localStorage.getItem('token');
            const res = await fetch('/shorten', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ url: document.getElementById('longUrl').value, custom_key: document.getElementById('customKey').value })
            });
            const data = await res.json();
            if(res.ok) { 
                loadMyLinks(); 
                const fullLink = window.location.origin + "/" + data.short_key;
                const resultP = document.getElementById('result');
                resultP.innerHTML = `üëâ <a href="${fullLink}" target="_blank">${fullLink}</a>`;
                resultP.classList.remove('hidden');
            }
            else if(res.status === 403) { if(confirm("R√©serv√© aux membres PRO. Voir les offres ?")) showPricing(); }
            else { alert(data.detail); }
        }

        async function loadMyLinks() {
            const token = localStorage.getItem('token');
            const res = await fetch('/users/me', { headers: { 'Authorization': 'Bearer ' + token } });
            
            if (res.ok) {
                const user = await res.json();
                if (user.is_premium) {
                    document.getElementById('premiumBtn').classList.add('hidden');
                    document.getElementById('proBadge').classList.remove('hidden');
                    document.getElementById('customKey').placeholder = "Votre alias personnalis√©";
                } else {
                    document.getElementById('premiumBtn').classList.remove('hidden');
                    document.getElementById('proBadge').classList.add('hidden');
                    document.getElementById('customKey').placeholder = "Alias (ex: google) - PRO seulement";
                }

                const tbody = document.getElementById('linksTableBody');
                tbody.innerHTML = ''; 
                user.items.forEach(item => {
                    const shortUrl = window.location.origin + "/" + item.short_key;
                    const historyData = JSON.stringify(item.click_history);
                    tbody.innerHTML += `<tr>
                        <td><a href="${shortUrl}" target="_blank">/${item.short_key}</a></td>
                        <td>${item.url.substring(0, 20)}...</td>
                        <td><strong>${item.clicks}</strong></td>
                        <td>
                            <button class='stats-btn' onclick='openChart("${item.short_key}", ${historyData})'>üìà</button>
                            <button class='delete-btn' onclick='deleteLink("${item.short_key}")'>X</button>
                        </td>
                    </tr>`;
                });
            } else { logout(); }
        }

        // --- GRAPHIQUES ---
        let myChartInstance = null;
        function openChart(shortKey, history) {
            document.getElementById('chartModal').classList.remove('hidden');
            document.getElementById('chartTitle').innerText = "Stats pour /" + shortKey;
            
            const clicksByDate = {};
            history.forEach(h => {
                const date = new Date(h.timestamp).toLocaleDateString();
                clicksByDate[date] = (clicksByDate[date] || 0) + 1;
            });

            const ctx = document.getElementById('myChart').getContext('2d');
            if(myChartInstance) myChartInstance.destroy();

            myChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(clicksByDate),
                    datasets: [{
                        label: 'Clics par jour',
                        data: Object.values(clicksByDate),
                        backgroundColor: '#1095c1'
                    }]
                },
                options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });
        }
        function closeChart() { document.getElementById('chartModal').classList.add('hidden'); }

        async function deleteLink(k) { if(confirm("S√ªr ?")) { await fetch('/links/'+k, { method: 'DELETE', headers: {'Authorization': 'Bearer '+localStorage.getItem('token')} }); loadMyLinks(); } }
        async function startPayment() { const u = (await (await fetch('/create-checkout-session', {method:'POST', headers:{'Authorization':'Bearer '+localStorage.getItem('token')}})).json()).checkout_url; window.location.href = u; }

        checkAuthRedirect();
    </script>
</body>
</html>